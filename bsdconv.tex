\documentclass{article}
\usepackage{float}
\usepackage{tikz}
\usepackage{colortbl}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{positioning}
\usetikzlibrary{shapes}
\title{BSDCONV}
\date{}
\begin{document}
	\maketitle
	\tableofcontents
	\section{Syntax}
		\subsection{Phases \& Cascade}
			\paragraph{}
			There are three types of conversion phases defined in bsdconv: \textbf{from}, \textbf{inter}, \textbf{to}. The \textbf{from} phase takes byte sequence and decodes it into a list of code points, on the other hand, the \textbf{to} phase encodes the list of code points back to byte sequence. The \textbf{inter} phase does code point to code point mapping.
			\paragraph{}
			A basic conversion consists of \textbf{from} and \textbf{to} phases. Search of codec name is case insensitive.
			\begin{figure}[H]
				\centering
				\begin{tikzpicture}[auto,node distance=0,on grid=false]

				    % Place nodes
				    \node (d0) {};
				    \node [right=of d0](from) {ISO-8859-1};
				    \node [right=of from](d1) {:};
				    \node [right=of d1] (to) {UTF-8};
				    \node [right=of to] (d2) {};
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}]
(d0)--(d1)  node  [black,midway,yshift=-1cm] { from };
				
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}]
(d1) -- (d2)  node [black,midway,yshift=-1cm] { to };
				
				\end{tikzpicture}
				\caption{Basic two phases conversion}
			\end{figure}
			
			\paragraph{}
			Between \textbf{from} and \textbf{to} phases, we can have an \textbf{inter} phase.
			\begin{figure}[H]
				\centering
				\begin{tikzpicture}[auto,node distance=0,on grid=false]			
				    % Place nodes
				    \node (d0) {};
				    \node [right=of d0](from) {UTF-8};
				    \node [right=of from](d1) {:};
				    \node [right=of d1] (inter) {UPPER};
				    \node [right=of inter](d2) {:};
				    \node [right=of d2] (to) {UTF-8};
				    \node [right=of to] (d3) {};			
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}]
	(d0) -- (d1) node [black,midway,yshift=-1cm] { from };
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}]
	(d1) -- (d2) node [black,midway,yshift=-1cm] { inter };
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}]
	(d2) -- (d3) node [black,midway,yshift=-1cm] { to };
				\end{tikzpicture}
				\caption{Conversion with inter-mapping phase}
			\end{figure}
			
			\paragraph{}
			There can be more than one \textbf{inter} phases.
			\begin{figure}[H]
				\centering
				\begin{tikzpicture}[auto,node distance=0,on grid=false]
				    % Place nodes
				    \node (d0) {};
				    \node [right=of d0](from) {UTF-8};
				    \node [right=of from](d1) {:};
				    \node [right=of d1] (inter) {UPPER};
				    \node [right=of inter](d2) {:};
				    \node [right=of d2] (inter2) {FULL};
				    \node [right=of inter2](d3) {:};
				    \node [right=of d3] (to) {UTF-8};
				    \node [right=of to] (d4) {};			
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}]
	(d0) -- (d1) node [black,midway,yshift=-1cm] { from };
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}]
	(d1) -- (d2) node [black,midway,yshift=-1cm] { inter };
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}]
	(d2) -- (d3) node [black,midway,yshift=-1cm] { inter };
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}]
	(d3) -- (d4) node [black,midway,yshift=-1cm] { to };
				
				\end{tikzpicture}
				\caption{Conversion with multiple inter-mapping phases}
			\end{figure}

			\paragraph{}
			An \textbf{inter} phase can be used standalonely, mostly in programmatic way.
			\begin{figure}[H]
				\centering
				\begin{tikzpicture}[auto,node distance=0,on grid=false]

				    % Place nodes
				    \node (d0) {};
				    \node [right=of d0](inter) {HALF};
				    \node [right=of inter] (d1) {};
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}]
(d0)--(d1)  node  [black,midway,yshift=-1cm] { inter };
				\end{tikzpicture}
				\caption{Standalone inter-mapping phase}
			\end{figure}
			
			\paragraph{}
			Conversions can be cascaded with pipe symbol. In most cases it is equivalent to shell pipe unless the use of codecs manipulating flag (described in section 2.2).
			\begin{figure}[H]
				\centering
				\begin{tikzpicture}[auto,node distance=0,on grid=false]
				    % Place nodes
				    \node (d0) {};
				    \node [right=of d0] (from) {UTF-8};
				    \node [right=of from] (d1) {:};
				    \node [right=of d1] (to) {BIG5};
				    \node [right=of to] (d2) {$|$};
				    \node [right=of d2] (from2) {BIG5};
				    \node [right=of from2](d3) {:};
				    \node [right=of d3](to2) {UTF-8};
				    \node [right=of to2] (d4) {};
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}] (d0) -- (d1) node [black,midway,yshift=-1cm] { from };
				
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}] (d1) -- (d2) node [black,midway,yshift=-1cm] { to };

					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}] (d2) -- (d3) node [black,midway,yshift=-1cm] { from };

					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}] (d3) -- (d4) node [black,midway,yshift=-1cm] { to };
				
				\end{tikzpicture}
				\caption{Cascaded conversions}
			\end{figure}
		
		\subsection{Codecs \& Fallback}
			\paragraph{}
			A phase consists of one or more codecs, separated by comma. The latter codecs will be utilized if and only if the former codecs fail to consume the incoming data, once a codec finish its task, the first codec will be up again for upcoming data.
			\begin{figure}[H]
				\centering
				\begin{tikzpicture}[auto,node distance=0,on grid=false]
				    % Place nodes
				    \node (d0) {};
				    \node [right=of d0] (from) {UTF-8};
				    \node [right=of from] (d1) {:};
				    \node [right=of d1] (to) {ASCII};
				    \node [right=of to] (d2) {,};
				    \node [right=of d2] (from2) {3F};
				    \node [right=of from2] (d3) {};
					
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}] (d0) -- (d1) node [black,midway,yshift=-1cm] { from };
				
					\draw [decorate,decoration={brace,amplitude=5pt,raise=3mm, mirror}] (d1) -- (d3) node [black,midway,yshift=-1cm] { to };
				
				\end{tikzpicture}
				\caption{Fallback codec}
			\end{figure}
			
		\subsection{Codec argument}
			\paragraph{}
			Some codecs take arguments, after the hash symbol.
			\begin{figure}[H]
				\centering
				\begin{tikzpicture}[auto,node distance=0,on grid=false]
				    % Place nodes
				    \node (d0) {};
				    \node [right=of d0] (from) {UTF-8};
				    \node [right=of from] (d1) {:};
				    \node [right=of d1] (to) {ASCII};
				    \node [right=of to] (d2) {,};
				    \node [right=of d2] (to2) {ANY\#3F};
				    \node [right=of from2] (d3) {};
				
				\end{tikzpicture}
				\caption{Passing argument to codec}
			\end{figure}
			
			\paragraph{}
			Some codecs take arguments in key-value form. Argument name and value consist of numbers, alphabets, hyphen and underscore, binary data are represented in hexadecimal form. 
			\begin{figure}[H]
				\centering
				\begin{tikzpicture}[auto,node distance=0,on grid=false]
				    % Place nodes
				    \node (d0) {};
				    \node [right=of d0](from) {UTF-8};
				    \node [right=of from](d1) {:};
				    \node [right=of d1] (to) {ASCII};
				    \node [right=of to] (d2) {,};
				    \node [right=of d2] (to2) {ESCAPE\#PREFIX=2575};
				    \node [right=of to2] (d3) {};
				
				\end{tikzpicture}
				\caption{Passing argument to codec in key-value form}
			\end{figure}

			\paragraph{}
			Multiple arguments can be passed by being concatenated with ampersand.
			\begin{figure}[H]
				\centering
				\begin{tikzpicture}[auto,node distance=0,on grid=false]
				    % Place nodes
				    \node (d0) {};
				    \node [right=of d0](from) {UTF-8};
				    \node [right=of from](d1) {:};
				    \node [right=of d1] (to) {ASCII};
				    \node [right=of to] (d2) {,};
				    \node [right=of d2] (to2) {ESCAPE\#PREFIX=262378\&SUFFIX=3B};
				    \node [right=of to2] (d3) {};
				
				\end{tikzpicture}
				\caption{Passing multiple arguments to codec}
			\end{figure}
	\clearpage
	\section{Type \& Flag}
		\tikzstyle{data} = [rectangle, draw, text width=2em, text centered]
		\tikzstyle{type} = [rectangle, draw, fill=blue!30, text width=2em, text centered]
		\tikzstyle{flag} = [rectangle, fill=yellow, text width=2em, text centered]

		\subsection{Type}
			\paragraph{}
				A code point packet note its type at first byte.
				\begin{table}[H]
					\centering
					\begin{tabular}{|>{\columncolor{blue!30}}c | l | c | c|}
						\hline
						ID & Description & Provider(from) & Consumer(to)\\
						\hline
						00 & Bsdconv special characters & BSDCONV\_KEYWORD & BSDCONV\_KEYWORD\\
						01 & Unicode & Most decoder & Most encoder\\
						02 & CNS11643\footnotemark[1] & CNS11643 & CNS11643\\
						03 & Byte & BYTE; ESCAPE & BYTE; ESCAPE\#FILTER=BYTE\\
						04 & Chinese components & inter/ZH\_DECOMP & inter/ZH\_COMP\\
						1B & ANSI control sequence & ANSI-CONTROL & -\\
						\hline
					\end{tabular}
					\caption{Types and its provider/consumer (just to name a few)}
				\end{table}
				\footnotetext[1]{As for the intersection of CNS11643 and Unicode, from/CNS11643 does conversion to unicode type if possible. Vice versa, to/CNS11643 does conversion from unicode type if possible.}
				\begin{figure}[H]
					\centering
					\begin{tikzpicture}[auto,node distance=1cm,on grid=false]
					    % Place nodes
					    \node [rectangle,draw] (input) {A$\forall$};
					    \node [below=0 of input] {Input (UTF-8 literal)};
					    \node [ellipse,draw,right=of input] (decoder) {ASCII,BYTE : ...};
					    \node [below=0 of decoder] {Decoder};
					    \node [rectangle,draw,right=of decoder] (internal) {
							\begin{tikzpicture}[node distance=3mm]
								\node [type](n0){01};
								\node [below=0 of n0,data](n1){41};
								\node [right=of n0,type](n2){03};
								\node [below=0 of n2,data](n3){E2};
								\node [right=of n2,type](n4){03};
								\node [below=0 of n4,data](n5){88};
								\node [right=of n4,type](n6){03};
								\node [below=0 of n6,data](n7){80};
								\draw [->] (n0) -- (n2);
								\draw [->] (n2) -- (n4);
								\draw [->] (n4) -- (n6);
							\end{tikzpicture}
					    };
					    \node [below=0 of internal] {Internal data};
					    \node [ellipse,draw,below=3cm of input] (encoder) {... : ASCII,ESCAPE};
					    \node [below=0 of encoder] {Encoder};
					    					    \node [rectangle,draw,right=of encoder] (internal2) {
							\begin{tikzpicture}[node distance=3mm]
								\node [data](n0){41};
								\node [above=0 of n0]{"A"};
								\node [right=of n0,data](n1){25};
								\node [below=0 of n1,data](n2){45};
								\node [below=0 of n2,data](n3){32};
								\node [above=0 of n1]{"\%E2"};
								\node [right=of n1,data](n4){25};
								\node [below=0 of n4,data](n5){38};
								\node [below=0 of n5,data](n6){38};
								\node [above=0 of n4]{"\%88"};
								\node [right=of n4,data](n7){25};
								\node [below=0 of n7,data](n8){38};
								\node [below=0 of n8,data](n9){30};
								\node [above=0 of n7]{"\%80"};
								\draw [->] (n0) -- (n1);
								\draw [->] (n1) -- (n4);
								\draw [->] (n4) -- (n7);
							\end{tikzpicture}
					    };
					    \node [below=0 of internal2] {Internal data};
					    \node [rectangle,draw,right=of internal2] (output) {A\%E2\%88\%80};
					    \node [below=0 of output] {Output (UTF-8 literal)};
					
						\draw [->] (input) -- (decoder);
						\draw [->] (decoder) -- (internal);
						\draw [->] (internal.east) -- ++ (0.5,0) -- ++ (0,-2) -| (encoder.north);
						\draw [->] (encoder) -- (internal2);
						\draw [->] (internal2) -- (output);
					\end{tikzpicture}
					\caption{Fallback \& Type}
				\end{figure}
		\clearpage
		
		\subsection{Flag}
			\paragraph{}
			A code point packet carries its own flags. Currently there are two types of flag, \textbf{FREE} and \textbf{SKIP}. Flag \textbf{FREE} indicates that the packet buffer needs to be recycled or released, this is used only when programming is involved. Flag \textbf{SKIP} is (currently only) added by codec to/UNICODE and used by codec from/SKIP to identify which packets have already been decoded and needs to be passed through in \textbf{from} phase. 
			\paragraph{}
			The code point packets structure is retained, including flags, within cascaded conversions, but not for shell pipe. Figure 11 demonstrate the flow of converion "ESCAPE:UNICODE,BYTE$|$SKIP,UTF-8:UTF-8".
				\begin{figure}[H]
					\centering
					\begin{tikzpicture}[auto,node distance=0.5cm,on grid=false]
					    % Place nodes
					    \node [rectangle,draw] (input) {\%u03B1\%CE\%B2};
					    \node [below=0 of input] {Input (UTF-8 literal)};
					    \node [ellipse,draw,right=1cm of input] (decoder) {ESCAPE : ...};
					    \node [below=0 of decoder] {Decoder};
					    \node [rectangle,draw,right=1cm of decoder] (internal) {
							\begin{tikzpicture}[node distance=3mm]
								\node [type](n0){01};
								\node [below=0 of n0,data](n1){03};
								\node [below=0 of n1,data](n2){B1};
								\node [right=of n0,type](n3){03};
								\node [below=0 of n3,data](n4){CE};
								\node [right=of n3,type](n5){03};
								\node [below=0 of n5,data](n6){B2};
								\draw [->] (n0) -- (n3);
								\draw [->] (n3) -- (n5);
							\end{tikzpicture}
					    };
					    \node [below=0 of internal] {Internal data};
					    \node [ellipse,draw,below=3cm of input] (encoder) {... : UNICODE,BYTE};
					    \node [below=0 of encoder] {Encoder};
					    					    \node [rectangle,draw,right=of encoder] (internal2) {
							\begin{tikzpicture}[node distance=3mm]
								\node [type](n0){01};
								\node [below=0 of n0,data](n1){03};
								\node [below=0 of n1,data](n2){B1};
								\node [below=0 of n2,flag]{SKIP};
								\node [right=of n0,data](n3){CE};
								\node [right=of n3,data](n5){B2};
								\draw [->] (n0) -- (n3);
								\draw [->] (n3) -- (n5);
							\end{tikzpicture}
					    };
						\node [below=0 of internal2] {Internal data};
						\node [ellipse,draw,right=of internal2] (decoder2) {SKIP,UTF-8 : ...};
						\node [below=0 of decoder2] {Decoder};
					    \node [rectangle,draw,below=2.5cm of encoder] (internal3) {
							\begin{tikzpicture}[node distance=3mm]
								\node [type](n0){01};
								\node [below=0 of n0,data](n1){03};
								\node [below=0 of n1,data](n2){B1};
								\node [below=0 of n2,flag]{SKIP};
								\node [right=of n0,type](n3){01};
								\node [below=0 of n3,data](n4){03};
								\node [below=0 of n4,data](n5){B2};
								\draw [->] (n0) -- (n3);
							\end{tikzpicture}
					    };
					    \node [below=0 of internal3] {Internal data};
						\node [ellipse,draw,right=of internal3] (encoder2) {... : UTF-8};
						\node [below=0 of encoder2] {Encoder};
					    \node [rectangle,draw,right=of encoder2] (internal4) {
							\begin{tikzpicture}[node distance=3mm]
								\node [data](n0){CE};
								\node [below=0 of n0,data](n1){B1};
								\node [above=0 of n0]{"$\alpha$"};
								\node [right=of n0,data](n2){CE};
								\node [below=0 of n2,data](n3){B2};
								\node [above=0 of n2]{"$\beta$"};
								\draw [->] (n0) -- (n2);
							\end{tikzpicture}
					    };
					    \node [below=0 of internal4] {Internal data};
   					    \node [right=2cm of internal4,rectangle,draw] (output) {$\alpha\beta$};
					    \node [below=0 of output] {Output (UTF-8 literal)};

						\draw [->] (input) -- (decoder);
						\draw [->] (decoder) -- (internal);
						\draw [->] (internal.east) -- ++ (1,0) -- ++ (0,-2) -| (encoder.north);
						\draw [->] (encoder) -- (internal2);
						\draw [->] (internal2) -- (decoder2);
						\draw [->] (decoder2.east) -- ++ (0.3,0) -- ++ (0,-2) -| (internal3.north);
						\draw [->] (internal3) -- (encoder2);
						\draw [->] (encoder2) -- (internal4);
						\draw [->] (internal4) -- (output);

					\end{tikzpicture}
					\caption{Flag, to/UNICODE \& from/SKIP}
				\end{figure}
				
		\subsection{Helper codecs}
			\paragraph{}
			Codec from/bsdconv can be used to input internal data structure, and codec to/bsdconv\_stdout can be used to inspect type and flags.
\end{document}
